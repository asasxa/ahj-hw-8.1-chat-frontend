(()=>{"use strict";class e{constructor(e){this.input=e}outputError(e){const t=this.input.nextElementSibling;t&&t.classList.contains("error")&&t.remove();const s=document.createElement("p");s.className="error",s.textContent=e,this.input.parentNode.insertBefore(s,this.input.nextSibling),this.input.disabled=!0,setTimeout(()=>{s.parentNode&&s.remove(),this.input.disabled=!1},2e3)}}class t{static getUsersHTML(e,t){const s=document.createDocumentFragment();return e.forEach(e=>{const a=document.createElement("li");a.className="users-list__user "+(e===t?"self":""),a.textContent=e===t?"You":e,s.appendChild(a)}),s}static getTime(){const e=new Date;return new Intl.DateTimeFormat("ru-RU",{dateStyle:"short",timeStyle:"short"}).format(e).split(",").reverse().join(" ")}static addMessage(e,t,s,a){const r=this.getTime(),o=document.createElement("div");o.className="message "+(t.author===s?"self":"");const n=document.createElement("div");n.className="message__header",n.textContent=`${t.author===s?"You":t.author}, ${r}`;const i=document.createElement("div");i.className="message__text",i.textContent=t.message,o.appendChild(n),o.appendChild(i),e.appendChild(o),a&&(a.scrollTop=a.scrollHeight)}}const s=document.querySelector(".modal"),a=s.querySelector(".modal__form"),r=a.querySelector(".modal-form__input"),o=document.querySelector(".chat-widget"),n=o.querySelector(".chat-widget__messages-container"),i=o.querySelector(".chat-widget__messages"),c=o.querySelector(".chat-widget__input"),d=document.querySelector(".status-loading"),l=document.querySelector(".users-list-container"),u=l.querySelector(".users-list"),m=new e(r),h="ahj-hw-8-1-chat-backend.onrender.com",p=new class extends e{constructor(e,t,s,a){super(s),this.modal=t,this.loading=a,this.baseUrl=e,this.contentTypeHeader={"Content-Type":"application/json"}}async connection(e=10,t=2e3){let s=0;const a=async()=>{try{const e=await fetch(`${this.baseUrl}/check`);if(e.ok)return this.loading.classList.remove("active"),this.modal.classList.add("active"),!0;throw new Error(`HTTP ${e.status}`)}catch(r){return s++,console.warn(`Попытка ${s} не удалась:`,r.message),s>=e?(this.outputError("Не удалось подключиться к серверу. Проверьте соединение и обновите страницу."),this.loading.classList.remove("active"),!1):(await new Promise(e=>setTimeout(e,t)),a())}};return a()}async add(e){this.input.disabled=!0,this.input.placeholder="Подождите, ваш запрос обрабатывается...";try{const t=await fetch(`${this.baseUrl}/users`,{method:"POST",headers:this.contentTypeHeader,body:JSON.stringify(e)});if(!t.ok){await t.text();throw new Error(400===t.status?"Bad Request":t.statusText)}return t}catch(e){this.input.placeholder="",this.input.disabled=!1,"Failed to fetch"===e.message?this.outputError("Ошибка! Сервер недоступен."):"Bad Request"===e.message?this.outputError("Ошибка! Имя уже существует."):this.outputError(`Неизвестная ошибка: ${e.message}.`)}}}(`https://${h}`,s,r,d);p.connection(),a.onsubmit=e=>{e.preventDefault();const{value:a}=r;if(!a||!a.trim())return r.value="",void m.outputError("Ошибка! Введено пустое значение.");const v=a.trim();r.value="",(async()=>{try{if(!await p.add({name:v}))return;d.textContent="Подключение к чату...",d.classList.add("active");const e=new WebSocket(`wss://${h}`);e.addEventListener("error",()=>{d.classList.remove("active"),m.outputError("Не удалось подключиться к чату. Попробуйте позже.")}),e.addEventListener("close",()=>{c.disabled=!0,c.placeholder="Соединение с сервером потеряно"}),e.addEventListener("open",()=>{d.classList.remove("active"),s.classList.remove("active"),o.classList.add("active"),c.disabled=!1,c.placeholder="Введите ваше сообщение",c.focus(),l.classList.add("active")}),e.addEventListener("message",e=>{try{const s=JSON.parse(e.data);Array.isArray(s)?(u.textContent="",u.appendChild(t.getUsersHTML(s,v))):s&&"object"==typeof s&&s.author&&s.message&&t.addMessage(i,s,v,n)}catch(t){console.warn("Некорректные данные от сервера:",e.data)}}),c.addEventListener("keyup",t=>{if("Enter"===t.key){const t=c.value.trim();if(!t)return void(c.value="");e.readyState===WebSocket.OPEN&&e.send(JSON.stringify({author:v,message:t})),c.value=""}}),document.addEventListener("click",e=>{e.target.closest(".chat-widget")||(c.value="")})}catch(e){console.error("Неожиданная ошибка при инициализации чата:",e),d.classList.remove("active")}})()}})();