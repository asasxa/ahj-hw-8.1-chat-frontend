(()=>{"use strict";class e{constructor(e){this.input=e}outputError(e){const t=this.input.nextElementSibling;t&&t.classList.contains("error")&&t.remove();const s=document.createElement("p");s.className="error",s.textContent=e,this.input.parentNode.insertBefore(s,this.input.nextSibling),this.input.disabled=!0,setTimeout(()=>{s.parentNode&&s.remove(),this.input.disabled=!1},2e3)}}class t{static getUsersHTML(e,t){const s=document.createDocumentFragment();return e.forEach(e=>{const r=document.createElement("li");r.className="users-list__user "+(e===t?"self":""),r.textContent=e===t?"You":e,s.appendChild(r)}),s}static getTime(){const e=new Date;return new Intl.DateTimeFormat("ru-RU",{dateStyle:"short",timeStyle:"short"}).format(e).split(",").reverse().join(" ")}static addMessage(e,t,s,r){const a=this.getTime(),o=document.createElement("div");o.className="message "+(t.author===s?"self":"");const n=document.createElement("div");n.className="message__header",n.textContent=`${t.author===s?"You":t.author}, ${a}`;const i=document.createElement("div");i.className="message__text",i.textContent=t.message,o.appendChild(n),o.appendChild(i),e.appendChild(o),r&&(r.scrollTop=r.scrollHeight)}}const s=document.querySelector(".modal"),r=s.querySelector(".modal__form"),a=r.querySelector(".modal-form__input"),o=document.querySelector(".chat-widget"),n=o.querySelector(".chat-widget__messages-container"),i=o.querySelector(".chat-widget__messages"),c=o.querySelector(".chat-widget__input"),d=document.querySelector(".status-loading"),l=document.querySelector(".users-list-container"),u=l.querySelector(".users-list"),m=new e(a),h="simple-chat-2021.herokuapp.com",p=new class extends e{constructor(e,t,s,r){super(s),this.modal=t,this.loading=r,this.baseUrl=e,this.contentTypeHeader={"Content-Type":"application/json"}}async connection(e=10,t=2e3){let s=0;const r=async()=>{try{const e=await fetch(`${this.baseUrl}/check`);if(e.ok)return this.loading.classList.remove("active"),this.modal.classList.add("active"),!0;throw new Error(`HTTP ${e.status}`)}catch(a){return s++,console.warn(`Попытка ${s} не удалась:`,a.message),s>=e?(this.outputError("Не удалось подключиться к серверу. Проверьте соединение и обновите страницу."),this.loading.classList.remove("active"),!1):(await new Promise(e=>setTimeout(e,t)),r())}};return r()}async add(e){this.input.disabled=!0,this.input.placeholder="Подождите, ваш запрос обрабатывается...";try{const t=await fetch(`${this.baseUrl}/users`,{method:"POST",headers:this.contentTypeHeader,body:JSON.stringify(e)});if(!t.ok){await t.text();throw new Error(400===t.status?"Bad Request":t.statusText)}return t}catch(e){this.input.placeholder="",this.input.disabled=!1,"Failed to fetch"===e.message?this.outputError("Ошибка! Сервер недоступен."):"Bad Request"===e.message?this.outputError("Ошибка! Имя уже существует."):this.outputError(`Неизвестная ошибка: ${e.message}.`)}}}(`https://${h}`,s,a,d);p.connection(),r.onsubmit=e=>{e.preventDefault();const{value:r}=a;if(!r||!r.trim())return a.value="",void m.outputError("Ошибка! Введено пустое значение.");const d=r.trim();a.value="",(async()=>{try{if(!await p.add({name:d}))return;const e=new WebSocket(`wss://${h}`);e.addEventListener("error",e=>{console.error("WebSocket error:",e),c.disabled=!0,c.placeholder="Ошибка подключения к серверу"}),e.addEventListener("close",()=>{c.disabled=!0,c.placeholder="Работа сервера приостановлена"}),e.addEventListener("open",()=>{c.disabled=!1,c.placeholder="Введите ваше сообщение",l.classList.add("active")}),e.addEventListener("message",e=>{try{const s=JSON.parse(e.data);Array.isArray(s)?(u.textContent="",u.insertAdjacentHTML("beforeend",t.getUsersHTML(s,d))):s&&"object"==typeof s&&s.author&&s.message&&t.addMessage(i,s,d,n)}catch(t){console.warn("Некорректные данные от сервера:",e.data)}}),c.addEventListener("keyup",t=>{if("Enter"===t.key){const t=c.value.trim();if(!t)return void(c.value="");const s=JSON.stringify({author:d,message:t});e.readyState===WebSocket.OPEN?e.send(s):console.warn("Сообщение не отправлено: WebSocket не подключён"),c.value=""}}),document.addEventListener("click",e=>{e.target.closest(".chat-widget")||(c.value="")}),s.classList.remove("active"),o.classList.add("active"),c.focus()}catch(e){console.error("Неожиданная ошибка при инициализации чата:",e)}})()}})();